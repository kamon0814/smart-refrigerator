<!doctype html>
<html xmlns:th="http://www.thymeleaf.org">
  <head>
    <title>ãƒ¬ã‚·ãƒ”ç”Ÿæˆçµæœ</title>
    <link rel="stylesheet" th:href="@{/styles.css}" />
  </head>
  <body>
    <div class="container">
      <header class="page-header">
        <h1>ãƒ¬ã‚·ãƒ”çµæœ</h1>
        <nav class="nav-links">
          <a class="nav-button nav-primary" th:href="@{/inventory}">
            <span class="nav-icon">â†©ï¸</span>
            <span>åœ¨åº«ä¸€è¦§ã¸æˆ»ã‚‹</span>
          </a>
          <a class="nav-button nav-warning" th:href="@{/recipes}">
            <span class="nav-icon">ğŸ“</span>
            <span>ä¿å­˜æ¸ˆã¿ãƒ¬ã‚·ãƒ”</span>
          </a>
        </nav>
      </header>

      <section class="card">
        <h2 class="section-title">AIææ¡ˆãƒ¬ã‚·ãƒ”ï¼ˆ2ä»¶ï¼‰</h2>
        <div class="recipe-list" th:if="${#lists.isEmpty(recipes)}">
          ãƒ¬ã‚·ãƒ”ãŒç”Ÿæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚
        </div>
        <div class="recipe-list" th:if="${!#lists.isEmpty(recipes)}">
          <article class="recipe-item" th:each="recipe, iter : ${recipes}">
            <div class="recipe-card" th:attr="data-recipe=${iter.index}">
              <div class="recipe-header">
                <span class="recipe-badge" th:text="'ãƒ¬ã‚·ãƒ” ' + ${iter.count}">
                  ãƒ¬ã‚·ãƒ” 1
                </span>
                <div class="recipe-title">
                  <span class="recipe-title-text">ã‚¿ã‚¤ãƒˆãƒ«</span>
                </div>
              </div>
              <button
                class="button toggle-save"
                type="button"
                th:attr="data-recipe=${iter.index}"
              >
                ãƒ¬ã‚·ãƒ”ã‚’ä¿å­˜
              </button>
              <div class="recipe-detail markdown"></div>
            </div>
            <pre
              class="recipe-source"
              th:attr="data-recipe=${iter.index}"
              th:text="${recipe}"
            >
                ãƒ¬ã‚·ãƒ”ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™
            </pre>
            <input
              type="hidden"
              th:attr="data-recipe=${iter.index}"
              class="recipe-content"
              th:value="${recipe}"
              th:attrappend="data-saved=${savedContents.contains(recipe)}"
            />
          </article>
        </div>
      </section>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
      (function () {
        if (!window.marked) {
          return;
        }
        const getTitle = (markdown, fallbackTitle) => {
          const tokens = marked.lexer(markdown || "");
          let title = "";
          for (const token of tokens) {
            if (!title && token.type === "heading") {
              title = token.text;
              break;
            }
          }

          if (!title) {
            const lines = (markdown || "")
              .split("\n")
              .map((line) => line.trim())
              .filter((line) => line.length > 0);
            if (lines[0] === "æ–™ç†å" && lines[1]) {
              title = lines[1];
            } else if (lines[0]) {
              title = lines[0].replace(/^#+\s*/, "");
            }
          }

          return title || fallbackTitle || "ãƒ¬ã‚·ãƒ”";
        };

        const stripFirstHeading = (markdown) => {
          if (!markdown) {
            return "";
          }
          const lines = markdown.split("\n");
          let startIndex = 0;
          while (startIndex < lines.length && lines[startIndex].trim() === "") {
            startIndex += 1;
          }
          if (startIndex < lines.length) {
            const line = lines[startIndex].trim();
            if (line.startsWith("#")) {
              startIndex += 1;
            } else if (line === "æ–™ç†å" && startIndex + 1 < lines.length) {
              startIndex += 2;
            }
            while (
              startIndex < lines.length &&
              lines[startIndex].trim() === ""
            ) {
              startIndex += 1;
            }
          }
          return lines.slice(startIndex).join("\n");
        };

        document.querySelectorAll(".recipe-source").forEach((source) => {
          const key = source.dataset.recipe;
          const card = document.querySelector(
            `.recipe-card[data-recipe="${key}"]`,
          );
          if (!card) {
            return;
          }
          const markdown = source.textContent || "";
          const detail = card.querySelector(".recipe-detail");
          const titleText = card.querySelector(".recipe-title-text");
          const title = getTitle(markdown, titleText?.textContent);
          if (titleText) {
            titleText.textContent = title;
          }
          if (detail) {
            detail.innerHTML = marked.parse(stripFirstHeading(markdown));
          }
        });

        const updateButtonState = (button, saved) => {
          if (!button) {
            return;
          }
          if (saved) {
            button.classList.add("saved");
            button.textContent = "ä¿å­˜æ¸ˆã¿ï¼ˆè§£é™¤ï¼‰";
          } else {
            button.classList.remove("saved");
            button.textContent = "ãƒ¬ã‚·ãƒ”ã‚’ä¿å­˜";
          }
        };

        document.querySelectorAll(".recipe-content").forEach((input) => {
          const key = input.dataset.recipe;
          const saved = input.dataset.saved === "true";
          const button = document.querySelector(
            `.toggle-save[data-recipe="${key}"]`,
          );
          updateButtonState(button, saved);
        });

        document.querySelectorAll(".toggle-save").forEach((button) => {
          button.addEventListener("click", async () => {
            const key = button.dataset.recipe;
            const input = document.querySelector(
              `.recipe-content[data-recipe="${key}"]`,
            );
            const recipe = input?.value || "";
            if (!recipe) {
              return;
            }
            button.disabled = true;
            try {
              const response = await fetch("/recipe/toggle", {
                method: "POST",
                headers: {
                  "Content-Type":
                    "application/x-www-form-urlencoded;charset=UTF-8",
                },
                body: new URLSearchParams({ recipe }),
              });
              if (!response.ok) {
                throw new Error("toggle failed");
              }
              const data = await response.json();
              input.dataset.saved = data.saved ? "true" : "false";
              updateButtonState(button, data.saved);
            } catch (error) {
              console.error(error);
            } finally {
              button.disabled = false;
            }
          });
        });
      })();
    </script>
  </body>
</html>
